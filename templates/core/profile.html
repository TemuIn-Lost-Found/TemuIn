{% extends 'base.html' %}

{% block header_title %}My Profile{% endblock %}

{% block content %}
<div class="profile-container" style="display: flex; gap: 24px; flex-wrap: wrap;">
    <!-- Profile Info -->
    <div
        style="flex: 1; min-width: 300px; background: var(--bg-secondary); padding: 24px; border-radius: 8px; height: fit-content;">
        <div style="text-align: center; margin-bottom: 24px;">
            <!-- Profile Picture -->
            <div style="position: relative; display: inline-block;">
                {% if user.ProfilePicture %}
                <img src="/profile/picture/{{ user.ID }}" alt="{{ user.Username }}"
                    style="width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 16px; object-fit: cover; box-shadow: var(--shadow-md);">
                {% else %}
                <div
                    style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: white; box-shadow: var(--shadow-md);">
                    {{ user.Username|slice:":1"|upper }}
                </div>
                {% endif %}
            </div>

            <!-- User Info - Different for admin and regular users -->
            {% if user.IsSuperuser %}
                <!-- Admin view -->
                <h2 style="margin: 0; color: var(--text-header); font-size: 24px;">{{ user.Username }}</h2>
                <div style="display:flex; align-items:center; justify-content:center; gap:6px; margin-top:8px;">
                    <span class="badge badge-admin" style="background:#faa61a; color:black;">Admin</span>
                </div>
                <div style="color: var(--text-muted); margin-top: 12px; font-size:13px;">Member since {{ FormatTime(user.DateJoined, "Jan 2006") }}</div>
            {% else %}
                <!-- Regular user view -->
                <h2 style="margin: 0; color: var(--text-header); font-size: 20px; font-weight:700;">{{ user.FirstName }} {{ user.LastName }}</h2>
                
                <div style="color: var(--text-muted); margin-top: 4px; font-size:14px; font-weight:500;">
                    @{{ user.Username }}
                </div>
                
                {% if user.Email %}
                <div style="color: var(--text-muted); font-size: 13px; margin-top: 8px; display:flex; align-items:center; justify-content:center; gap:6px;">
                    <span class="material-icons" style="font-size:14px;">email</span> {{ user.Email }}
                </div>
                {% endif %}
                
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 12px; border-top:1px solid var(--bg-tertiary); padding-top:12px;">
                    Member since {{ FormatTime(user.DateJoined, "Jan 2006") }}
                </div>
            {% endif %}

            <!-- Edit Profile Button -->
            <button onclick="toggleEditMode()" class="btn" style="margin-top: 20px; padding: 8px 24px; font-size: 13px; font-weight:600; background-color: var(--bg-tertiary); color: var(--text-normal); border:1px solid var(--bg-tertiary);">
                Edit Profile
            </button>
        </div>

        <!-- Edit Profile Form (Hidden by default) -->
        <div id="edit-profile-form" style="display: none; margin-bottom: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; border:1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0; font-size: 16px; color: var(--text-header);">Edit Profile</h3>
                <button type="button" onclick="toggleEditMode()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <form id="profile-update-form" enctype="multipart/form-data">
                <input type="hidden" name="delete_picture" id="delete_picture_input" value="false">
                
                <!-- Profile Picture Upload -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--text-muted); font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 8px;">
                        Profile Picture
                    </label>
                    <div style="display:flex; gap:12px; align-items:start;">
                        <div style="flex:1;">
                            <input type="file" name="profile_picture" accept="image/*" onchange="previewImage(event)"
                                style="padding: 8px; border: 1px solid var(--bg-secondary); background:var(--bg-secondary); border-radius: 4px; width: 100%; color:var(--text-normal); font-size:13px;">
                            <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Max size 2MB. JPG, PNG.</div>
                        </div>
                        {% if user.ProfilePicture %}
                        <button type="button" id="btn-delete-photo" onclick="markPhotoForDeletion()" class="btn" style="background:#ef4444; color:white; padding:8px 12px; font-size:12px; flex-shrink:0;">
                            <span class="material-icons" style="font-size:16px; vertical-align:middle;">delete</span> Remove
                        </button>
                        {% endif %}
                    </div>
                    
                    <div id="image-preview" style="margin-top: 12px; display: none;">
                        <img id="preview" src="" alt="Preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border:2px solid var(--accent);">
                        <span style="font-size:12px; color:var(--accent); margin-left:8px; vertical-align:middle;">New photo selected</span>
                    </div>
                    <div id="delete-preview" style="margin-top:8px; display:none; color:#ef4444; font-size:12px;">
                        <span class="material-icons" style="font-size:14px; vertical-align:text-bottom;">delete</span> Photo will be removed on save
                    </div>
                </div>

                <!-- Username Edit -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--text-muted); font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 8px;">
                        Username
                    </label>
                    <input type="text" name="username" value="{{ user.Username }}" required
                        style="padding: 10px; border: 1px solid var(--bg-secondary); background:var(--bg-secondary); color:var(--text-normal); border-radius: 4px; width: 100%;">
                </div>

                <div id="profile-update-error" style="display: none; padding:10px; background:rgba(239,68,68,0.1); border-radius:6px; color: var(--red); font-size: 13px; margin-bottom: 16px;"></div>

                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn" style="flex: 1; background-color: var(--accent); color: white; padding:10px;">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>

        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: bold;">Wallet
                Balance</div>
            <div style="font-size: 24px; color: var(--gold); font-weight: bold; margin: 4px 0;">
                {{ user.CoinBalance }} <span style="font-size: 14px; color: var(--text-normal);">Coins</span>
            </div>

            <!-- TopUp Options -->
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px 0; color: var(--text-header); font-size: 14px;">Top Up Coins</h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="topUpCoins(100)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--accent-secondary);">
                        <span>üí∞ 100 Coins</span>
                        <span style="font-weight: bold;">Rp 1.000</span>
                    </button>
                    <button onclick="topUpCoins(500)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--accent-secondary);">
                        <span>üí∞ 500 Coins</span>
                        <span style="font-weight: bold;">Rp 5.000</span>
                    </button>
                    <button onclick="topUpCoins(1000)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--accent-secondary);">
                        <span>üí∞ 1.000 Coins</span>
                        <span style="font-weight: bold;">Rp 10.000</span>
                    </button>
                </div>
                <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted); text-align: center;">
                    Secure payment powered by Midtrans
                </div>
            </div>
        </div>


        <!-- Witdhrawal Section -->
        <a href="/withdraw" class="btn"
            style="width:100%; margin-top:8px; display:block; text-align:center; text-decoration:none; background-color: var(--accent); color: white;">Tukar
            / Cairkan Coins</a>

        <div>
            <h4 style="color: var(--text-header); border-bottom: 1px solid var(--bg-tertiary); padding-bottom: 8px;">
                Account Stats</h4>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Reports Posted</span>
                <span style="color: var(--text-header);">{{ items|length }}</span>
            </div>
        </div>
    </div>

    <!-- My Reports -->
    <div style="flex: 2; min-width: 300px;">
        <h3 style="color: var(--text-header); margin-top: 0; margin-bottom: 16px;">My Reports</h3>
        <div class="card-grid">
            {% for item in items %}
            <div class="thread-card">
                {% if item.Image %}
                <img src="/images/{{ item.ID }}" alt="{{ item.Title }}" class="card-image">
                {% else %}
                <div class="card-image"
                    style="display: flex; align-items: center; justify-content: center; color: #72767d;">
                    <span class="material-icons">image_not_supported</span>
                </div>
                {% endif %}

                <div class="card-content">
                    <h4 class="card-title">{{ item.Title }}</h4>
                    <div class="card-meta">
                        <span class="card-badge badge-{{ item.Status|lower }}">{{ item.Status }}</span>
                        <a href="/item/{{ item.ID }}" style="color: var(--accent); text-decoration: none;">View</a>
                    </div>
                    {% if not item.IsHighlighted and item.Status == 'LOST' %}
                    <form action="/item/{{ item.ID }}/highlight" method="post" style="margin-top: 8px;">

                        <button type="submit" class="btn"
                            style="width: 100%; font-size: 12px;font-weight: bold; background-color: var(--gold); color: black;">
                            Boost (50 Coins)
                        </button>
                    </form>
                    {% endif %}
                    {% if item.IsHighlighted %}
                    <div style="margin-top: 8px; font-size: 12px; color: var(--gold); text-align: center;">Target
                        Highlighted!</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div
                style="color: var(--text-muted); padding: 20px; text-align: center; background: var(--bg-secondary); border-radius: 8px; width: 100%;">
                You haven't posted any items yet.
            </div>
            {% endfor %}
        </div>

        <!-- My Discoveries Section -->
        <h3 style="color: var(--text-header); margin-top: 32px; margin-bottom: 16px;">My Discoveries</h3>
        <div class="card-grid">
            {% for item in found_items %}
            <div class="thread-card">
                {% if item.Image %}
                <img src="/images/{{ item.ID }}" alt="{{ item.Title }}" class="card-image">
                {% else %}
                <div class="card-image"
                    style="display: flex; align-items: center; justify-content: center; color: var(--text-muted); background: var(--bg-tertiary);">
                    <span class="material-icons">volunteer_activism</span>
                </div>
                {% endif %}

                <div class="card-content">
                    <h4 class="card-title">{{ item.Title }}</h4>
                    <div class="card-meta">
                        <span class="card-badge badge-found">FOUND</span>
                        <a href="/item/{{ item.ID }}" style="color: var(--accent); text-decoration: none;">View</a>
                    </div>
                    <div
                        style="margin-top: 8px; font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 4px;">
                        <span class="material-icons" style="font-size: 14px;">check_circle</span>
                        You found this!
                    </div>
                </div>
            </div>
            {% empty %}
            <div
                style="color: var(--text-muted); padding: 20px; text-align: center; background: var(--bg-secondary); border-radius: 8px; width: 100%;">
                You haven't found any items yet.
            </div>
            {% endfor %}
        </div>

        <!-- Riwayat Transaksi -->
        <h3 style="color: var(--text-header); margin-top: 32px; margin-bottom: 12px;">Riwayat Transaksi</h3>
        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
            {% if transactions and transactions|length > 0 %}
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="text-align:left; color:var(--text-muted); font-size:12px;">
                        <th style="padding:8px 6px;">Tanggal</th>
                        <th style="padding:8px 6px;">Tipe</th>
                        <th style="padding:8px 6px;">Coins</th>
                        <th style="padding:8px 6px;">Nominal (Rp)</th>
                        <th style="padding:8px 6px;">Metode</th>
                        <th style="padding:8px 6px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr style="border-top:1px solid var(--bg-tertiary);">
                        <td style="padding:8px 6px;">{{ t.Date }}</td>
                        <td style="padding:8px 6px;">
                            {% if t.Type == "TopUp" %}
                            <span style="color: var(--green); font-weight: 500;">Top Up</span>
                            {% else %}
                            <span style="color: var(--amber); font-weight: 500;">Withdraw</span>
                            {% endif %}
                        </td>
                        <td style="padding:8px 6px; font-weight: bold; color: var(--gold);">
                            {% if t.Type == "Withdraw" %}-{% else %}+{% endif %}{{ t.Amount }}
                        </td>
                        <td style="padding:8px 6px;">
                            {% if t.Price > 0 %}Rp {{ t.Price }}{% else %}-{% endif %}
                        </td>
                        <td style="padding:8px 6px;">
                            {% if t.Method %}{{ t.Method|upper }}{% else %}-{% endif %}
                        </td>
                        <td style="padding:8px 6px;">
                            {% if t.Status == "success" %}
                            <span style="color:var(--green); font-weight:600;">Sukses</span>
                            {% elif t.Status == "pending" %}
                            <span style="color:#faa61a; font-weight:600;">Pending</span>
                            {% elif t.Status == "failed" or t.Status == "rejected" %}
                            <span style="color: var(--red); font-weight:600;">Gagal</span>
                            {% else %}
                            <span style="color:var(--text-muted);">{{ t.Status|title }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="color:var(--text-muted); padding: 24px; text-align:center;">
                Belum ada riwayat transaksi.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Midtrans Snap.js  -->
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
<script>
    // helper to sleep (optional)
    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    async function topUpCoins(amount, evt) {
        evt = evt || window.event;
        const buttons = document.querySelectorAll('.topup-btn');
        const clickedButton = evt.target.closest('.topup-btn');

        // Disable all buttons and show loading
        buttons.forEach(btn => btn.disabled = true);
        const originalContent = clickedButton.innerHTML;
        clickedButton.innerHTML = '<span>‚è≥ Processing...</span>';

        try {
            const res = await fetch('/topup/initiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount })
            });
            const data = await res.json();
            if (!data.snap_token) throw new Error(data.error || 'No token returned');

            const orderId = data.order_id;

            // Open snap popup
            snap.pay(data.snap_token, {
                onSuccess: function (result) {
                    // Immediately confirm with Midtrans core API
                    confirmAndFinalize(orderId, clickedButton, originalContent, buttons);
                },
                onPending: function (result) {
                    // Start polling to check status (useful for QRIS)
                    startPollingConfirm(orderId, clickedButton, originalContent, buttons);
                },
                onError: function (err) {
                    console.error('Snap error', err);
                    alert('‚ùå Pembayaran gagal. Silakan coba lagi.');
                    buttons.forEach(btn => btn.disabled = false);
                    clickedButton.innerHTML = originalContent;
                },
                onClose: function () {
                    // user closed popup ‚Äî re-enable
                    buttons.forEach(btn => btn.disabled = false);
                    clickedButton.innerHTML = originalContent;
                }
            });
        } catch (err) {
            console.error(err);
            alert('‚ùå Gagal memulai pembayaran: ' + (err.message || 'Unknown'));
            buttons.forEach(btn => btn.disabled = false);
            if (clickedButton) clickedButton.innerHTML = originalContent;
        }
    }

    // Polling helper: ping /topup/confirm every 5s up to 2 minutes
    function startPollingConfirm(orderId, clickedButton, originalContent, buttons) {
        let attempts = 0;
        const maxAttempts = 24; // 24 * 5s = 120s
        const interval = setInterval(async () => {
            attempts++;
            try {
                const r = await fetch('/topup/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                const json = await r.json();
                if (json && json.local_status === 'success') {
                    clearInterval(interval);
                    alert('‚úÖ Pembayaran terverifikasi! Coins ditambahkan.');
                    window.location.reload();
                    return;
                }
            } catch (e) {
                console.error('Polling error', e);
            }

            if (attempts >= maxAttempts) {
                clearInterval(interval);
                alert('‚ö†Ô∏è Timeout verifikasi. Silakan cek riwayat topup.');
                buttons.forEach(btn => btn.disabled = false);
                if (clickedButton) clickedButton.innerHTML = originalContent;
            }
        }, 5000);
    }

    async function confirmAndFinalize(orderId, clickedButton, originalContent, buttons) {
        try {
            const r = await fetch('/topup/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId })
            });
            const json = await r.json();
            if (json && json.local_status === 'success') {
                alert('‚úÖ Pembayaran berhasil! Coins Anda telah ditambahkan.');
                window.location.reload();
            } else {
                alert('‚ö†Ô∏è Pembayaran sukses di Midtrans tetapi belum diverifikasi. Silakan cek riwayat topup.');
                window.location.reload();
            }
        } catch (e) {
            console.error('Confirm error', e);
            alert('‚ùå Gagal memverifikasi pembayaran. Cek server logs.');
            buttons.forEach(btn => btn.disabled = false);
            if (clickedButton) clickedButton.innerHTML = originalContent;
        }
    }


    // Profile Edit Functions
    function toggleEditMode() {
        const editForm = document.getElementById('edit-profile-form');
        const errorDiv = document.getElementById('profile-update-error');
        if (editForm.style.display === 'none') {
            editForm.style.display = 'block';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        } else {
            editForm.style.display = 'none';
        }
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('preview');
                const previewContainer = document.getElementById('image-preview');
                const deleteInput = document.getElementById('delete_picture_input');
                const deletePreview = document.getElementById('delete-preview');
                
                preview.src = e.target.result;
                previewContainer.style.display = 'block';
                
                // Reset delete flag if new image selected
                deleteInput.value = 'false';
                deletePreview.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    function markPhotoForDeletion() {
        const deleteInput = document.getElementById('delete_picture_input');
        const deletePreview = document.getElementById('delete-preview');
        const previewContainer = document.getElementById('image-preview');
        const fileInput = document.querySelector('input[name="profile_picture"]');
        
        deleteInput.value = 'true';
        deletePreview.style.display = 'block';
        
        // Hide new image preview if exists
        previewContainer.style.display = 'none';
        fileInput.value = ''; // clear file input
    }

    // Handle profile update form submission
    document.getElementById('profile-update-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const errorDiv = document.getElementById('profile-update-error');
        
        try {
            const response = await fetch('/profile/update', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ Profile updated successfully!');
                window.location.reload();
            } else {
                errorDiv.textContent = data.error || 'Failed to update profile';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        }
    });

</script>
{% endblock %}