{% extends 'base.html' %}

{% block header_title %}My Profile{% endblock %}

{% block content %}
<div class="profile-container" style="display: flex; gap: 24px; flex-wrap: wrap;">
    <!-- Profile Info -->
    <div
        style="flex: 1; min-width: 300px; background: var(--bg-secondary); padding: 24px; border-radius: 8px; height: fit-content;">
        <div style="text-align: center; margin-bottom: 24px;">
            <div
                style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: white;">
                {{ user.Username|slice:":1"|upper }}
            </div>
            <h2 style="margin: 0; color: var(--text-header);">{{ user.Username }}</h2>
            <div style="color: var(--text-muted);">Member since {{ FormatTime(user.DateJoined, "Jan 2006") }}</div>
        </div>

        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: bold;">Wallet
                Balance</div>
            <div style="font-size: 24px; color: var(--gold); font-weight: bold; margin: 4px 0;">
                {{ user.CoinBalance }} <span style="font-size: 14px; color: var(--text-normal);">Coins</span>
            </div>

            <!-- TopUp Options -->
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px 0; color: var(--text-header); font-size: 14px;">Top Up Coins</h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="topUpCoins(100)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--green);">
                        <span>üí∞ 100 Coins</span>
                        <span style="font-weight: bold;">Rp 1.000</span>
                    </button>
                    <button onclick="topUpCoins(500)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--green);">
                        <span>üí∞ 500 Coins</span>
                        <span style="font-weight: bold;">Rp 5.000</span>
                    </button>
                    <button onclick="topUpCoins(1000)" class="btn topup-btn"
                        style="width: 100%; display: flex; justify-content: space-between; align-items: center; background: var(--green);">
                        <span>üí∞ 1.000 Coins</span>
                        <span style="font-weight: bold;">Rp 10.000</span>
                    </button>
                </div>
                <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted); text-align: center;">
                    Secure payment powered by Midtrans
                </div>
            </div>
        </div>

        <div>
            <h4 style="color: var(--text-header); border-bottom: 1px solid var(--bg-tertiary); padding-bottom: 8px;">
                Account Stats</h4>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Reports Posted</span>
                <span style="color: var(--text-header);">{{ items|length }}</span>
            </div>
        </div>
    </div>

    <!-- My Reports -->
    <div style="flex: 2; min-width: 300px;">
        <h3 style="color: var(--text-header); margin-top: 0; margin-bottom: 16px;">My Reports</h3>
        <div class="card-grid">
            {% for item in items %}
            <div class="thread-card">
                {% if item.Image %}
                <img src="/static/{{ item.Image }}" alt="{{ item.Title }}" class="card-image">
                {% else %}
                <div class="card-image"
                    style="display: flex; align-items: center; justify-content: center; color: #72767d;">
                    <span class="material-icons">image_not_supported</span>
                </div>
                {% endif %}

                <div class="card-content">
                    <h4 class="card-title">{{ item.Title }}</h4>
                    <div class="card-meta">
                        <span class="card-badge badge-{{ item.Status|lower }}">{{ item.Status }}</span>
                        <a href="/item/{{ item.ID }}" style="color: var(--accent); text-decoration: none;">View</a>
                    </div>
                    {% if not item.IsHighlighted and item.Status == 'LOST' %}
                    <form action="/item/{{ item.ID }}/highlight" method="post" style="margin-top: 8px;">

                        <button type="submit" class="btn"
                            style="width: 100%; font-size: 12px; background-color: var(--gold); color: black;">
                            Boost (50 Coins)
                        </button>
                    </form>
                    {% endif %}
                    {% if item.IsHighlighted %}
                    <div style="margin-top: 8px; font-size: 12px; color: var(--gold); text-align: center;">Target
                        Highlighted!</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div
                style="color: var(--text-muted); padding: 20px; text-align: center; background: var(--bg-secondary); border-radius: 8px; width: 100%;">
                You haven't posted any items yet.
            </div>
            {% endfor %}
        </div>

        <!-- My Discoveries Section -->
        <h3 style="color: var(--text-header); margin-top: 32px; margin-bottom: 16px;">My Discoveries</h3>
        <div class="card-grid">
            {% for item in found_items %}
            <div class="thread-card">
                {% if item.Image %}
                <img src="/static/{{ item.Image }}" alt="{{ item.Title }}" class="card-image">
                {% else %}
                <div class="card-image"
                    style="display: flex; align-items: center; justify-content: center; color: #72767d; background: #2f3136;">
                    <span class="material-icons">volunteer_activism</span>
                </div>
                {% endif %}

                <div class="card-content">
                    <h4 class="card-title">{{ item.Title }}</h4>
                    <div class="card-meta">
                        <span class="card-badge badge-found">FOUND</span>
                        <a href="/item/{{ item.ID }}" style="color: var(--accent); text-decoration: none;">View</a>
                    </div>
                    <div
                        style="margin-top: 8px; font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 4px;">
                        <span class="material-icons" style="font-size: 14px;">check_circle</span>
                        You found this!
                    </div>
                </div>
            </div>
            {% empty %}
            <div
                style="color: var(--text-muted); padding: 20px; text-align: center; background: var(--bg-secondary); border-radius: 8px; width: 100%;">
                You haven't found any items yet.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Midtrans Snap.js  -->
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
<script>
    function topUpCoins(amount) {
        // Get the button that was clicked
        const buttons = document.querySelectorAll('.topup-btn');
        const clickedButton = event.target.closest('.topup-btn');

        // Disable all buttons and show loading
        buttons.forEach(btn => btn.disabled = true);
        const originalContent = clickedButton.innerHTML;
        clickedButton.innerHTML = '<span>‚è≥ Processing...</span>';

        // Call backend to get Snap token
        fetch('/topup/initiate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ amount: amount })
        })
            .then(response => response.json())
            .then(data => {
                if (data.snap_token) {
                    // Open Snap payment popup
                    snap.pay(data.snap_token, {
                        onSuccess: function (result) {
                            console.log('Payment success:', result);
                            alert('‚úÖ Pembayaran berhasil! Coins Anda telah ditambahkan.');
                            window.location.reload();
                        },
                        onPending: function (result) {
                            console.log('Payment pending:', result);
                            alert('‚è≥ Menunggu pembayaran. Silakan selesaikan pembayaran Anda.');
                            window.location.reload();
                        },
                        onError: function (result) {
                            console.error('Payment error:', result);
                            alert('‚ùå Pembayaran gagal. Silakan coba lagi.');
                            // Re-enable buttons
                            buttons.forEach(btn => btn.disabled = false);
                            clickedButton.innerHTML = originalContent;
                        },
                        onClose: function () {
                            console.log('Payment popup closed');
                            // Re-enable buttons
                            buttons.forEach(btn => btn.disabled = false);
                            clickedButton.innerHTML = originalContent;
                        }
                    });
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Gagal memulai pembayaran'));
                    buttons.forEach(btn => btn.disabled = false);
                    clickedButton.innerHTML = originalContent;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Terjadi kesalahan saat memproses pembayaran');
                buttons.forEach(btn => btn.disabled = false);
                clickedButton.innerHTML = originalContent;
            });
    }
</script>
{% endblock %}